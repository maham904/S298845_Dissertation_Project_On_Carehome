{% extends 'core/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Staff Mappings</h2>
        {% if not show_form %}
            <a href="?show_form=true" class="btn btn-primary">Create Mapping</a>
        {% endif %}
    </div>

    {% if show_form %}
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <strong>New Mapping</strong>
        </div>
        <div class="card-body">
            <form method="post" action="">
                {% csrf_token %}

                <div class="form-group mb-3">
                    <label for="id_carehomes">Care Home</label>
                    {{ form.carehomes }}
                </div>

                <div class="form-group mb-3">
                    <label for="id_staff">Staff</label>
                    {{ form.staff }}
                </div>

                <div class="form-group mb-3">
                    <label for="id_service_users">Service User</label>
                    <select name="service_users" id="id_service_users" class="form-control" required>
                        <option value="">Select Care Home first</option>
                    </select>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-success">Save</button>
                    <a href="{% url 'staff-mapping' %}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {% if mappings %}
    <div class="card shadow-sm">
        <div class="card-header">
            <strong>Saved Mappings</strong>
        </div>
        <div class="card-body p-0">
            <table class="table table-bordered mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Staff Name</th>
                        <th>Mapped To</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mapping in mappings %}
                    <tr>
                        <td>{{ mapping.id }}</td>
                        <td>{{ mapping.staff }}</td>
                        <td>{{ mapping.assigned_to }}</td>
                        <td>{{ mapping.created_at }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
        <div class="alert alert-info mt-4">No mapping found.</div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
    // Initialize Select2
    $('#id_carehomes').select2({
        placeholder: "Select a care home",
        allowClear: true,
        width: '100%'
    });

    $('#id_service_users').select2({
        placeholder: "First select a care home",
        allowClear: true,
        width: '100%'
    });

    // Handle carehome selection change
    $('#id_carehomes').on('change', function() {
        const selected = $(this).select2('data');
        const carehomeId = selected.length > 0 ? selected[0].id : null;
        const $serviceUsers = $('#id_service_users');

        $serviceUsers.empty().prop('disabled', true).trigger('change');

        if (carehomeId) {
            $serviceUsers.select2({
                placeholder: "Loading service users...",
                allowClear: false
            });

            // Ensure we only send one ID
            $.ajax({
                url: '{% url "get-service-users-by-carehome" %}',
                data: { 'carehome_id': carehomeId },  // Single ID only
                dataType: 'json',
                success: function(response) {
                    $serviceUsers.empty();
                    if (response.service_users?.length) {
                        $.each(response.service_users, function(i, user) {
                            $serviceUsers.append(
                                $('<option>', {
                                    value: user.id,
                                    text: user.name
                                })
                            );
                        });
                        $serviceUsers.prop('disabled', false).trigger('change');
                    } else {
                        $serviceUsers.select2({
                            placeholder: "No service users found",
                            allowClear: false
                        });
                    }
                },
                error: function(xhr) {
                    console.error('Error:', xhr.responseJSON);
                    $serviceUsers.select2({
                        placeholder: "Error loading service users",
                        allowClear: false
                    });
                }
            });
        } else {
            $serviceUsers.select2({
                placeholder: "First select a care home",
                allowClear: true
            }).prop('disabled', false);
        }
    });
});
</script>
{% endblock %}